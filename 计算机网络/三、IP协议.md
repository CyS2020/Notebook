## IP协议 即网际协议

IP大致分为三大作用模块：**IP寻址**、**路由**、**IP分包与分组**

### 1. 网络层与数据链路层

-   计算机通信中为了识别通信对端，必须要有一个类似与地址的识别码进行标识。数据链路的MAC地址正是用来标识同一个链路中不同计算机的一种识别码。IP地址用于在**连接到网络中的所有主机中识别出进行通信的目标地址**，TCP/IP通信中所有主机或路由器必须设定自己的IP地址

-   数据链路层的主要作用是在互连同一种数据链路的节点之间进行包传递，跨越多种数据链路就需要网络层
-   数据链路层提供直连两个设备之间的通信功能，网络层的IP负责在没有直连的两个网络之间进行通信传输

### 2. 路由控制

-   多跳路由是指路由器或主机在转发IP数据包是只指定 下一个路由器或主机，而不是将到最终目标的地址为止的所有通路全部指定出来。因为每一跳在转发IP数据包时会分别指定吓一跳的操作，直至达到最终的目标地址

-   路由控制表的形成有：一种是管理员手动设置称为静态路由控制，另一种是路由器与其他路由器相互交换信息时动态刷新。IP本身并没有定义制作路由控制表的协议，该表由路由协议制作而成

-   路由控制是将分组数据发送到最终目标地址的功能，为了将数据包发送给目标主机，所有主机都维护者一张路由控制表，该表记录IP数据在下一步应该发给那个路由器，IP包将根据这个路由表在各个数据链路上传输

    ![根据路由表转发IP数据包](https://github.com/CyS2020/Notebook/raw/master/%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/%E6%A0%B9%E6%8D%AE%E8%B7%AF%E7%94%B1%E8%A1%A8%E8%BD%AC%E5%8F%91IP%E6%95%B0%E6%8D%AE%E5%8C%85.jpg)
    
-   默认采用最长匹配原则，匹配成功则转发，无匹配则找默认路由，默认路由都没有则丢弃

-   主机路由：例如192.168.153.15/32的意思是整个IP地址的所有位都将参与路由。进行主机路由意味着不希望通过网络地址路由的情况，造成路由表膨大，路由负荷增加，进而造成网络性能下降。

### 3. 数据链路的抽象化

-   IP是实现多个数据链路之间通信的协议，数据链路根据种类的不同各有特点，对这些不同数据链路的相异性进行抽象画也是IP的重要作用之一

-   不同数据链路最大的区别就是他们各自的最大传输单位-MTU不同。为了解决这个问题，IP进行分片处理，将较大的IP包分成多个较小的IP包。分片的包到了对端目标地址以后会再被组合起来传给上一层。

-   IP属于面向无连接型，一是为了简化，二是为了提速

### 4. IP地址的基础知识

-   IP地址由**网络地址**（网络标识）和 **主机地址**（主机标识）两部分组成

-   如何区分网络地址部分与主机地址部分，最初二者以分类进行区别，现在以子网掩码区分

    ![IP地址网路标识](https://github.com/CyS2020/Notebook/raw/master/%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/IP%E5%9C%B0%E5%9D%80%E7%BD%91%E7%BB%9C%E6%A0%87%E8%AF%86.jpg)

-   IP地址的分类A类、B类、C类、D类

    -   A类地址：首位以0开头的地址。从第1位到第8位是它的网络标识。0.0.0.0~127.0.0.0
    -   B类地址：以10开头的地址。从第1位到第16位是它的网络标识。128.0.0.0~191.255.0.0
    -   C类地址：以110开头的地址。从第1位到第24位是它的网络标识。192.0.0.0~223.255.255.0
    -   D类地址：以1110开头的地址。从第1位到第32位是它的网络标识。没有主机标识常用于**多播**

    ![IP地址的分类](https://github.com/CyS2020/Notebook/raw/master/%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/IP%E5%9C%B0%E5%9D%80%E7%9A%84%E5%88%86%E7%B1%BB.jpg)

    -   注意事项1：网络地址中除开头外全0或者全1的网络地址被保留即上述区间均为开区间
    -   注意事项2：主机地址中用比特位表示时，不可以全部为0或者全部为1。全0为网段号是用于三层寻址的地址，代表整个网络本身。全1为广播地址，代表了该网段全部的主机。网段中第一个地址是网络号，最后一个地址是广播地址

### 5. 广播地址

-   用于在同一个链路中相互连接的主机之间发送数据包。将IP地址中的主机部分全部设为1就成了广播地址

-   本地广播：在本网络内的广播叫做本地广播。例如网络地址为192.168.0.0/24的情况下广播地址是192.168.0.255。因为在这个广播地址的IP包会被路由器屏蔽所以不会到达192.168.0.0/24以外的其他链路

-   直接广播：在不同网络之间的广播叫做直接广播。例如网络地址为192.168.0.0/24的主机箱向192.168.1.255/24的目标地址发送IP包。收到这个包的路由器，将数据发给192.168.1.0/24，从而使得所有192.168.1.0~192.168.1.254的主机都能收到这个包

    ![本地广播与直接广播](https://github.com/CyS2020/Notebook/raw/master/%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/%E6%9C%AC%E5%9C%B0%E5%B9%BF%E6%92%AD%E4%B8%8E%E7%9B%B4%E6%8E%A5%E5%B9%BF%E6%92%AD.jpg)

### 6. IP多播

-   多播用于将包发送给特定组内的计算机。由于直接使用IP协议，因此也存在不可靠传输

-   对于1对N、N对N的通信需求明显上升，具体实现上往往复制1对1通信的数据，同时发送给多个主机

-   多播既可以穿透路由器，又可以实现只给那些必要的组发送数据包

    ![单播、广播、多播通信](https://github.com/CyS2020/Notebook/raw/master/%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/%E5%8D%95%E6%92%AD%E3%80%81%E5%B9%BF%E6%92%AD%E3%80%81%E5%A4%9A%E6%92%AD%E9%80%9A%E4%BF%A1.jpg)

-   IP多播使用的是D类地址，以1110开头，剩下28位可以成为多播的组编号。224.0.0.0~239.255.255.255都是多播地址可用的范围。

    -   局部链接多播地址：224.0.0.0~224.0.0.255，这是为路由协议和其他用途保留的地址，路由器并不转发属于此范围的IP包
    -   预留多播地址：224.0.1.0~238.255.255.255，可用于全球范围（如Internet）或网络协议
    -   管理权限多播地址：239.0.0.0~239.255.255.255，可供组织内部使用，类似于私有IP地址，不能用于Internet，可限制多播范围

    ![多播地址](https://github.com/CyS2020/Notebook/raw/master/%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/%E5%A4%9A%E6%92%AD%E5%9C%B0%E5%9D%80.jpg)

-   多播发送端为了实现多播的传递，必须设置TTL（Time To Live)限制包到达的范围，每经过一个路由器就减一，TTL变为0时，该数据包无法再被传递，只能销毁。

### 7. 子网掩码

-   32位的二进制数，IP地址网络标识部分的位为1，IP地址主机部分的位为0。从IP地址首位开始连续的1

-   由此IP地址可以不再受限于自己的类别，而是可以通过子网掩码自由地定位自己的网络标识的长度

    ![子网掩码灵活指定网络标识长度](https://github.com/CyS2020/Notebook/raw/master/%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E7%81%B5%E6%B4%BB%E6%8C%87%E5%AE%9A%E7%BD%91%E7%BB%9C%E6%A0%87%E8%AF%86%E9%95%BF%E5%BA%A6.jpg)

-   **CIDR**：采用固定长度的子网掩码机制；**VLSM**：采用可变长度的子网掩码机制

### 8. 全局地址与私有地址

-   包含在如下范围的IP地址都属于私有IP，在此之外的属于全局IP，私有地址范围：

    10.0.0.0~10.255.255.255（/8) A类

    172.16.0.0~172.31.255.255（/12) B类

    192.168.0.0~192.168.255.255（/16) C类。

-   私有IP最早没有计划接入互联网，而只用于互联网之外的独立网络，然而当一种能够互换私有IP地址与全局IP地址的NAT技术诞生之后，配有私有地址的主机与配有全局地址的互联网主机实现了通信

-   现在很多学校、家庭、公司内部正采用在每个终端设置私有IP，而在路由器或必要的服务器上设置全局IP地址的方法。如果配有私有IP地址主机连网时，则通过NAT进行通信

-   全局IP地址基本上要在整个互联网范围内保持唯一，但私有地址不需要，只要在同一个域里保证唯一即可

    不同的域里面出现相同的私有IP不会影响使用。由此私有IP地址结合NAT技术成为IP地址分配的主流方案

### 9. 路由表的聚合

-   利用网络地址的比特分布可以有效地进行分层配置。对内即使有多个子网掩码，对外呈现出的也是同一个网络地址。这样可以更好的构建网络，通过路由信息的聚合可以有效的减少路由表的条目

    ![路由控制表的聚合](https://github.com/CyS2020/Notebook/raw/master/%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6%E8%A1%A8%E7%9A%84%E8%81%9A%E5%90%88.jpg)

-   路由器对IP数据报进行分片处理，在重组的时候只能由目标主机进行。路由器虽然做分片但不会进行重组。

### 10. IPv4首部

![IP数据报格式](https://github.com/CyS2020/Notebook/raw/master/%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/IP%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.jpg)

-   版本：由4个比特构成，标识IP首部版本号，IPv4版本号即为4，因此在这个字段上的值也是“4”
-   首部长度：由4个比特构成，表面IP首部的大小，单位为4字节。对于没有可选项的IP包，首部长度设置为“5”，即有5个4单位的字节=20字节，最多有15个4单位的字节=60字节
-   区分服务：由8比特构成，用来表明服务质量。通常由应用软件指定，一般情况下不使用这个字段
-   总长度：由16比特构成，表示IP首部和数据部分合起来的总字节数
-   标识：由16比特构成，它是一个**计数器**，每产生一个数据报就+1，但他并不是序号。当一个数据报长度超过网路的MTU时，必须分片，此时每个数据报片都复制一次标识号以便能重装成原来的数据报。重装数据报在目的端主机完成
-   标志：由3比特构成，用于分片重组。**位0**：保留，必须为0；**位1**：禁止分片（DF = 0允许分片）；**位2**：更多分片（MF = 1代表后面还有分片，MF = 0代表已经是最后一个分片了）。如果DF = 1不允许分片，但路由器要求必须分片报文，则此报文会被丢弃
-   片偏移：由13比特位构成，指明了每个分片相对于原始报文开头的偏移量，单位为8字节
-   生存时间：由8比特构成，现实中为**跳数计数器**：报文经过每个路由器字段-1，当此字段为0时则丢弃报文，最大值是255。避免了在网络内无线传递的问题
-   协议：由8位比特构成，表示报文数据区使用的协议，IP包传输层上层的协议编号。
-   首部校验和：由16比特构成，只对首部进行查错，不包括数据部分。在每一跳，路由器都要将重新计算出的首部校验和并与此字段进行比对，如果不一致报文会被丢弃。重新计算必要性是因为每一跳的一些首部字段（TTL、Flag、Offset）都可能发生变化。数据区的校验留给上一层TCP、UDP等。
-   源地址：由32比特构成，表示发送端的IP地址
-   目标地址：由32比特构成，表示接收端的IP地址
-   可选字段：从1到40字节不等，只在实验或者诊断时使用。包含：安全级别、源路径、路径记录、时间戳
-   填充：再有可选字段的情况下，首部长度可能不是32比特的整数倍，通过填充0，调整为32比特的整数倍。
-   数据：数据字段不是首部的一部分，并不包含在首部检验和中。数据的格式在协议首部字段中被指明，并可以是任意传输层的协议