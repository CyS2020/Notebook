## 多线程并发编程

### 概念

-   CAS : compare and swap

-   ABA : 中间经历B又回到了A

-   lock cmpxchg 指令

-   Object o = new Object() 在内存中占用16个字节
    
    -   markword占8字节，指针压缩classpoint4字节，不压缩8字节，对齐字节整除8
    
-   上锁过程 ： new 0 0 1-> 偏向锁 1 0 1 -> 轻量级锁（无锁，自旋锁，自适应锁 0 0）->  重量级锁 1 0 -> GC标记信息 1 1
    -   标签一贴，偏向锁
    -   CAS方式多个线程一起贴标签，轻量级锁，不断的循环贴
    -   竞争激烈申请大锁，其他人进入这把锁的等待队列
    -   轻量级锁在用户态，重量级锁在内核态
    
-   自旋锁：占用CPU不访问操作系统，所以是用户态，不经过内核态
-   自旋锁与OS锁：执行时间长、线程数量多的用OS锁，执行时间特别短、线程数量少用自旋锁

-   锁消除：如果检测到不可能共享的资源，自动消除内部的锁

-   锁粗化：JVM检测到一连串的操作会对同一个对象加锁，就会把锁加到循环外面去

-   JIT ：Just In Time Compiler 即时编译器，热点代码直接编译成机器语言

-   volatile：保证线程可见性，一个线程改了另一个需要知道

-   超线程：一个ALU对应多个PC、Registers，所谓四核八线程

-   cache line ：64字节

-   MESI Cache 一致性协议：Modified Exclusive Share Invalid

-   乱序执行：读指令的同时可以同时执行不影响的其他指令，而写同时可以进行合并写

-   对象创建过程：new #2 <T>, invokespecial #3 <<T.init>>, astore_1

-   内存屏障：屏障两端指令不允许发生重排

-   volatile：JVM负责加内存屏障，操作系统负责实现内存屏障lock指令
    -   volatile i
    -   ACC_VOLATILE
    -   JVM内存屏障，volatile前后屏障
    -   hotspot实现，锁总线
    
-   强软弱虚：强软和垃圾回收有关，没有空间了欺负软的，弱引用看见了就回收，虚就是虚无的意思
    -   WeakReference
    -   SoftReference
    -   PhantomReference

-   ThreadLocal：和相关线程绑定，线程里有个map，key就是指ThreadLocal，value是指我们set的对象
               线程对象中有一个map:threadLocals对象，负责存ThreadLocal和set的对象
               ThreadLocal t1.set()方法执行时候，t1指向ThreadLocal，map中弱引用指向Entry.key即也是ThreadLocal

-   sheep:  睡一会，让其他线程执行
-   yield:  让一下，让其他线程有机会执行
-   join:   加一下，等待其他线程执行结束

-   线程状态迁移、new、runnable: ready、running、timedwaiting、waiting、blocked、terminate

-   synchronized(this)与public synchronized void method()是等值的
-   synchronized(T.class)与public synchronized static void method()是等值的
-   synchronized既保证了原子性又保证了可见性，锁的是对象不是代码
-   synchronized可重入：重复获得一把锁，不可重入的话一个对象两个方法m1调m2,那就会死锁

-   synchronized(object)
        mardword 记录这个线程ID(偏向锁)
        如果线程争用升级为自旋锁
        自旋10次以后，升级为重量锁 - OS
-   synchronized(object)中不能使用String常量、Integer、Long等基础类型

-   异常与锁：程序中出现异常的情况，默认情况下，锁会被释放

### 面试问题

-   synchronized实现过程
    -   java代码：synchronized
    -   monitorenter moniterexit
    -   执行过程中自动升级
    -   lock comxchg
    
