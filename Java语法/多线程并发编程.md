## 多线程并发编程

### 概念

-   CAS : compare and swap

-   ABA : 中间经历B又回到了A

-   lock cmpxchg 指令

-   Object o = new Object( ) 在内存中占用16个字节
    
    -   markword占8字节，指针压缩classpoint4字节，不压缩8字节，对齐字节整除8
    
-   上锁过程 ： new 0 0 1-> 偏向锁 1 0 1 -> 轻量级锁（无锁，自旋锁，自适应锁 0 0）->  重量级锁 1 0 -> GC标记信息 1 1
    -   标签一贴，偏向锁
    -   CAS方式多个线程一起贴标签，轻量级锁，不断的循环贴
    -   竞争激烈申请大锁，其他人进入这把锁的等待队列
    -   轻量级锁在用户态，重量级锁在内核态

-   锁消除：如果检测到不可能共享的资源，自动消除内部的锁

-   锁粗化：JVM检测到一连串的操作会对同一个对象加锁，就会把锁加到循环外面去

-   JIT ：Just In Time Compiler 即时编译器，热点代码直接编译成机器语言

-   volatile：保证线程可见性，一个线程改了另一个需要知道

-   超线程：一个ALU对应多个PC、Registers，所谓四核八线程

-   cache line ：64字节

-   MESI Cache 一致性协议：Modified Exclusive Share Invalid

-   乱序执行：读指令的同时可以同时执行不影响的其他指令，而写同时可以进行合并写

### 面试问题

-   synchronize实现过程
    -   java代码：synchronize
    -   monitorenter moniterexit
    -   执行过程中自动升级
    -   lock comxchg